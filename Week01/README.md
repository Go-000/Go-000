# 微服务概览与治理

## 概览
微服务主要是分而治之的思想，每个单一职责，开发维护的效率高，隔离部署，比较灵活。“没有银弹”，微服务也不是万能的。微服务是分布式系统，会带来固有的复杂性，如 IPC、数据分区、测试、服务版本依赖等。对基础设施的挑战比较大

组件服务化，多个微服务组合成一个完整的用户场景

微服务的划分可以按业务能力来组织，服务提供的能力和业务功能对应。不该划分出技术抽象的服务，它不反应真实的业务。(组织架构也需要相应调整)

基础设施需要自动化，否则太蛋疼，玩不嗨。包括测试、监控、指标、日志、CICD 等等

**Design For Failure** 思想认为任何地方都可能出错，与空气斗智斗勇。在微服务中需要处理隔离、超时控制、负载保护、限流、降级、重试、负载均衡...等一大堆事情


## B 站微服务演进
“没有什么是一层中间层解决不了的。如果有，那就再加一层” ———— 鲁迅

0. 按照垂直功能拆分，直接对外暴露服务
  - 客户端聚合数据，慢
  - 直接通信，强耦合，旧服务不敢撤
  - 协议不统一，服务端要适配各种端类型，兼容太麻烦，安全认证和限流等统一逻辑不能共用
1. 在微服务和出口之间增加一个 BFF(Backend for Frontend) 层，用来拼装数据，统一 API
  - BFF 是单点故障的，一出问题全要完蛋
  - 单个 BFF 业务集成度太高，代码堆太多，丑陋难维护
2. 按业务域和重要性拆成多个 BFF 层，集成度降低
  - 跨横切面的基础功能(如安全认证、日志监控、限流熔断等)升级麻烦，每个 BFF 都要跟着升级
3. 在 BFF 层之前再加一层 API Gateway 层，通用基础功能上沉，关注分离(Separation of Concerns)


## 划分
1. 如果组织结构能够闭环，就共一个服务，避免一个功能分散在好几个职能部门
2. 拆的比较细，需要扇出的请求比较多，要考虑整合


## 认证
API Gateway 认证成功后，使用 JWT 方式，通过 RPC 元数据的方式传到 BFF 层，BFF 校验 Token 后把身份信息放入 Context 中，传递到下层微服务(通过 UserID)


## 服务发现
**客户端发现**
client 从注册中心(通过心跳检测维护)拿到可用的服务 ip 列表，选择一个地址去直接请求

**服务端发现**
client 请求到 LB，由 LB 去注册中心拿 server 地址，直接转发过去

直观感觉，就是由按维护负载均衡的责任方来划分，xx 端发现就是 xx 端来维护

客户端发现是 client 直连 server，性能更好，但是需要自己维护负载均衡逻辑，不同语言都要实现一遍，比较麻烦

服务端发现的方式中，客户端更专注业务逻辑，拿地址、负载均衡等逻辑由 LB 去完成，感觉很美好。按理说业务无关的复杂性应该交给基础设施去维护，服务网格(Service Mesh) 就是这种架构，以边车(Sidecar)模式将网络代理与业务进程绑在一起，是非侵入式的，也解决了单一 LB 中心化的风险。缺点是多一次网络跳转，可能会有性能损失，而且感觉现在还不是很成熟

一个注册中心可以对应多个服务，整个系统有多个注册中心，它们不需要强一致性，维护好自己那一批服务就可以了，全局的注册和注销事件延迟一些没太大影响


## 多集群
特别重要的服务(如账号服务)需要搭建多集群，更保险，避免单个机房内的机房故障导致的服务不可用。面向事业部，给每个业务搭一个账号集群，互不影响，一个集群挂了可以切到另一个集群上面

集群在物理上是多套资源，逻辑上维护集群概念，服务启动的时候从环境变量中获取集群信息，注册的时候带入

DB 只有一个，应用从缓存中读取数据，每个集群独占一套自己的缓存，缓存通过订阅 binlog 变更来更新

两个业务服务可能数据正交，一个集群故障，切换到另一个集群后，出现一大波 cache miss，压力都打到数据库上。因此退而求其次，client 需要连所有集群，有负载均衡存在，这个集群的数据都是热的

全连接又会有大量心跳检测带来的 cpu 负载，需要一个算法，从全集群中选取一批节点，利用划分子集群限制连接池大小。尽量将后端平均分给客户端

算法描述: https://sre.google/sre-book/load-balancing-datacenter/#picking-the-right-subset-AVsohKUD


## 多租户
多租户可以模拟出多(理论上无数)套测试环境。利用元数据给服务打标记(染色发布)，测试流量带有特殊的请求头，会被负载均衡器转给相应的服务(列表改用 map，找到标记相应的连接)。核心是流量路由

除了要测试的服务，其他服务都直接用线上的，很方便，也很刺激

安全性考虑，外网传来的特殊 head 通通抹掉，内网的才可以放行
